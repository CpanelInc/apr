#!/usr/bin/make -f

__isa_bits       := 
__isa_name       := 
__sourcedir      := 
_datadir         := 
_lib             := lib64
_libdir          := /usr/lib64
_root_includedir := 
_root_libdir     := 
_root_sbindir    := 
_root_sysconfdir := 
_sysconfdir      := /etc
aprver           := 1
buildroot        := 
cpanel_version   := 1.7.0.6
ea_openssl_ver   := 1.1.1d-1
ix86             := i386
multilib_arches  := i386 ia64 ppc ppc64 s390 s390x x86_64
ns_name          := ea
pkgname          := ea-apr
prefix_bin       := /opt/cpanel/ea-apr16/bin
prefix_data      := /opt/cpanel/ea-apr16/share
prefix_dir       := /opt/cpanel/ea-apr16
prefix_inc       := /opt/cpanel/ea-apr16/include
prefix_lib       := /opt/cpanel/ea-apr16/lib64
prefix_name      := ea-apr16
release          := 6
release_prefix   := 6
scl_prefix       := 
version          := 1.7.0
DEB_INSTALL_ROOT := /usr/src/packages/BUILD/debian/tmp
DEB_SOURCE_ROOT  := /usr/src/packages/BUILD/debian/SOURCES_FROM_SPEC
SOURCE1          := $(DEB_SOURCE_ROOT)/apr-wrapper.h
SOURCE2          := $(DEB_SOURCE_ROOT)/macros.ea-apr
## END_MAKE_VARS

%:
	echo "EXECING $@"
	dh $@

override_dh_auto_configure:
	# regenerate configure script etc.
	./buildconf
	# Forcibly prevent detection of shm_open (which then picks up but
	# does not use -lrt).
	export ac_cv_search_shm_open=no
	./configure \
	        --with-devrandom=/dev/urandom \
	        --prefix=$(prefix_dir) \
	        --libdir=$(prefix_lib) \
	        --with-installbuilddir=$(prefix_lib)/apr-$(aprver)/build \
	        apr_lock_method=USE_SYSVSEM_SERIALIZE
	make 

override_dh_auto_install:
	rm -rf $(DEB_INSTALL_ROOT)
	make install DESTDIR=$(DEB_INSTALL_ROOT)
	mkdir -p $(DEB_INSTALL_ROOT)/$(prefix_data)/aclocal
	install -m 644 build/find_apr.m4 $(DEB_INSTALL_ROOT)/$(prefix_data)/aclocal
	# Trim exported dependecies
	sed -ri '/^dependency_libs/{s,-l(uuid|crypt) ,,g}' \
	      $(DEB_INSTALL_ROOT)$(prefix_lib)/libapr*.la
	# Also set pkgconfig to reference the right defs file
	sed -ri '/^LIBS=/{s,-l(uuid|crypt) ,,g;s/  */ /g};/pkg-config/{s,apr-$(aprver),$(prefix_name)-$(aprver),g}' \
	      $(DEB_INSTALL_ROOT)$(prefix_bin)/apr-$(aprver)-config
	sed -ri '/^Libs/{s,-l(uuid|crypt) ,,g}' \
	      $(DEB_INSTALL_ROOT)$(prefix_lib)/pkgconfig/apr-$(aprver).pc
	# In order for apr and our package to coexist, we have to name our
	# pkgconfig files something else
	mkdir -p $(DEB_INSTALL_ROOT)$(_libdir)/pkgconfig
	echo "PKGCONFIG: 001 " $(DEB_INSTALL_ROOT)$(_libdir)/pkgconfig
	find $(DEB_INSTALL_ROOT)$(prefix_lib) -type f -print0 | xargs -0 ls -ld
	mv $(DEB_INSTALL_ROOT)$(prefix_lib)/pkgconfig/apr-$(aprver).pc $(DEB_INSTALL_ROOT)$(_libdir)/pkgconfig/$(prefix_name)-$(aprver).pc
	echo "PKGCONFIG: 002 " $(DEB_INSTALL_ROOT)$(_libdir)/pkgconfig
	find $(DEB_INSTALL_ROOT)$(_libdir)/pkgconfig -type f -print0 | xargs -0 ls -ld
	# Unpackaged files:
	rm -f $(DEB_INSTALL_ROOT)$(prefix_lib)/apr.exp \
	      $(DEB_INSTALL_ROOT)$(prefix_lib)/libapr-*.a
	mkdir -p $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/CHANGES $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/LICENSE $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/NOTICE $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/docs/APRDesign.html $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/docs/canonical_filenames.html $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/docs/incomplete_types $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	cp /usr/src/packages/BUILD/docs/non_apr_programs $(DEB_INSTALL_ROOT)/usr/share/doc/ea-apr-$(version)
	mv $(DEB_INSTALL_ROOT)/$(prefix_inc)/apr-$(aprver)/apr.h $(DEB_INSTALL_ROOT)/$(prefix_inc)/apr-$(aprver)/apr-x86_64.h
	install -c -m644 $(SOURCE1) $(DEB_INSTALL_ROOT)/$(prefix_inc)/apr-$(aprver)/apr.h

override_dh_auto_test:
	echo "Ignoring Tests"
	/bin/true


